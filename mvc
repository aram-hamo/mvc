#!/usr/bin/env php
<?php
require_once 'vendor/autoload.php';
require '.config.php';
use AramHamo\Mvc\Schema;
function help(){
  echo "Usage:\n\n";
  echo "serve         launch a local dev server\n";
  echo "migrate       migrate\n";
}
function migrate(){
if(CONFIG["DATABASE"]["SOFTWARE"] == "sqlite"){
  if(!extension_loaded("pdo_sqlite")){
    echo "\033[31mError: \033[0mpdo_sqlite module not loaded\n";
    exit;
  }
}else if(CONFIG["DATABASE"]["SOFTWARE"] == "mysql"){
  if(!extension_loaded("pdo_mysql")){
    echo "\033[31mError: \033[0mpdo_mysql module not loaded\n";
    exit;
  }
}
  $tables = glob("migrations/*.php");
  foreach($tables as $table){
    include $table;
    echo "\033[32mCreating \033[0m". $GLOBALS['tableName']."\n";
    $table::up();
  }
}
function drop($tableName){
  $schema = new Schema;
  $schema->dropIfExists($tableName);
  echo "\033[32mDeleting \033[0m". $tableName."\n";
}
function dropall(){
  $schema = new Schema;
  $tables = glob("migrations/*.php");
  foreach($tables as $table){
    include $table;
    $schema->dropIfExists($GLOBALS["tableName"]);
    echo "\033[32mDeleting \033[0m". $GLOBALS["tableName"]."\n";
  }
}
if($argc < 2){
  help();

}elseif($argv[1] == "serve"){
  shell_exec("php -S 0.0.0.0:8080 -t public");

}elseif($argv[1] == "migrate"){
  migrate();

}elseif($argv[1] == "drop"){
  if(isset($argv[2])){
    drop($argv[2]);
  }

}elseif($argv[1] == "dropall"){
    dropall();

}else{
  help();

}
