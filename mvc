#!/usr/bin/env php
<?php
require_once 'vendor/autoload.php';
define("CONFIG",parse_ini_file('.env',true));
use AramHamo\Mvc\Schema;
function help(){
echo "Usage:\n
\033[32mserve                      \033[0mlaunch a local dev server
\033[32mmigrate                    \033[0mmigrate all
\033[32mmigrate \033[0m<table>            migrate a specific table
\033[32mdropall                    \033[0mdrop all tables
\033[32mdrop \033[0m<table>               drop a specific table
\033[32mnewpage \033[0m<pagename> <path>  create new page\n";
}
function migrate(){
if(CONFIG["DATABASE"]["SOFTWARE"] == "sqlite"){
  if(!extension_loaded("pdo_sqlite")){
    echo "\033[31mError: \033[0mpdo_sqlite module not loaded\n";
    exit;
  }
}else if(CONFIG["DATABASE"]["SOFTWARE"] == "mysql"){
  if(!extension_loaded("pdo_mysql")){
    echo "\033[31mError: \033[0mpdo_mysql module not loaded\n";
    exit;
  }
}
  $tables = glob("migrations/*.php");
  foreach($tables as $table){
    include $table;
    echo "\033[32mCreating \033[0m". $GLOBALS['tableName']."\n";
    $table::up();
  }
}
function drop($tableName){
  $schema = new Schema;
  $schema->dropIfExists($tableName);
  echo "\033[32mDeleting \033[0m". $tableName."\n";
}
function dropall(){
  $schema = new Schema;
  $tables = glob("migrations/*.php");
  foreach($tables as $table){
    include $table;
    $schema->dropIfExists($GLOBALS["tableName"]);
    echo "\033[32mDeleting \033[0m". $GLOBALS["tableName"]."\n";
  }
}
function newPage($pageName,$path){
  if(file_exists("controllers/".ucfirst($pageName).".php")){
    echo "\033[31mError:\033[0m Controller \033[32m".ucfirst($pageName)."\033[0m already exists\n";
    exit;
  }
  if(file_exists("views/".strtolower($pageName).".php")){
    echo "\033[31mError:\033[0m View \033[32m".strtolower($pageName)."\033[0m already exists\n";
    exit;
  }
  include "templates/route.php";
  include "templates/controller.php";
  copy('templates/view.php',"views/".strtolower($pageName).".php");
  $fController = fopen("controllers/".ucfirst($pageName.".php"),"w");
  $fRoute = fopen("routes/".strtolower($pageName.".php"),"w");
  fwrite($fController,$controllerTemplate);
  fwrite($fRoute,$routeTemplate);
}
if($argc < 2){
  help();

}elseif($argv[1] == "serve"){
  shell_exec("php -S 0.0.0.0:8080 -t public");

}elseif($argv[1] == "migrate"){
  migrate();

}elseif($argv[1] == "drop"){
  if(!isset($argv[2])){help();exit;}
  drop($argv[2]);

}elseif($argv[1] == "dropall"){
    dropall();

}elseif($argv[1] == "newpage"){
  if(!isset($argv[2])){help();exit;}
  newPage($argv[2],$argv[3]);

}else{
  help();

}
